{% extends 'base.html' %}
{% load static %}
{% block title %}Fiber Route Builder{% endblock %}
{% block extra_head %}
<style>
  #builderMap {
    height: 70vh;
    width: 100%;
  }

  .point-row:hover {
    background: #f1f5f9;
  }
</style>
{% endblock %}
{% block content %}
<h2 class="text-2xl font-bold mb-4">Fiber Route Builder</h2>
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <div class="lg:col-span-3 space-y-4">
    <div id="builderMap" class="rounded border border-gray-300"></div>
    <div class="flex gap-2 flex-wrap">
      <select id="fiberSelect" class="border rounded px-2 py-1 text-sm"></select>
      <button id="loadFiber" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-500">Load</button>
      <button type="button"
              onclick="openKmlModal()"
              class="bg-fuchsia-500 text-white px-3 py-1 rounded text-sm shadow-[0_0_12px_rgba(217,70,239,0.6)] hover:bg-fuchsia-400 hover:shadow-[0_0_16px_rgba(217,70,239,0.75)] transition">
        Import KML
      </button>
      <button id="editFiber" disabled
              class="bg-cyan-500 text-white px-3 py-1 rounded text-sm hover:bg-cyan-400 disabled:cursor-not-allowed disabled:bg-cyan-300 transition">
        Edit Cable
      </button>
      <button id="clearPath" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-400">Clear</button>
      <button id="savePath" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-500" disabled>Save</button>
      <button id="deleteCable" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-500">Delete Cable</button>
    </div>
  </div>
  <div class="space-y-4">
    <div class="bg-white rounded shadow p-4">
      <h3 class="font-semibold mb-2">Route Points</h3>
      <ol id="pointsList" class="text-sm space-y-1 max-h-64 overflow-auto"></ol>
      <p class="text-xs text-gray-500 mt-2">
        Click the map to add intermediate points. Drag a marker to adjust its position.
      </p>
      <p class="text-xs text-gray-500">
        Double-click an intermediate marker to remove it.
      </p>
      <div class="mt-2 text-sm">
        Estimated distance: <span id="distanceKm">0</span> km
      </div>
    </div>
    <div class="bg-white rounded shadow p-4">
      <h3 class="font-semibold mb-2">Help</h3>
      <ul class="list-disc ml-4 text-xs space-y-1">
        <li>The first two points can represent origin and destination when no saved path exists.</li>
        <li>Add intermediate points to reflect the physical cable path.</li>
        <li>Distance uses the Haversine formula as a geodesic approximation.</li>
      </ul>
    </div>
  </div>
</div>

{% include 'partials/save_manual_modal.html' %}

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/partials/import_kml.js' %}"></script>
<script defer src="{% static 'js/fiber_route_builder.js' %}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>
{% endblock %}
