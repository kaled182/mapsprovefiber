{% extends "base_dashboard.html" %}
{% block title %}Fiber Map{% endblock %}

{% block extra_head %}
{% load static %}
<style>
  /* Additional dashboard styles */
  #map {
    height: 70vh;
    width: 100%;
  }

  .legend {
    background: white;
    padding: 8px 12px;
    font-size: 12px;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, .2);
  }

  .legend div {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }

  .legend span.color {
    display: inline-block;
    width: 16px;
    height: 4px;
    margin-right: 6px;
    border-radius: 2px;
  }

  .fit-bounds-btn {
    background: white;
    border: 2px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 1px 4px rgba(0, 0, 0, .2);
    transition: all 0.2s;
  }

  .fit-bounds-btn:hover {
    background: #f5f5f5;
    border-color: #bbb;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }

  .status-available { background-color: #10b981; }
  .status-unavailable { background-color: #ef4444; }
  .status-unknown { background-color: #6b7280; }

  /* Modal styles */
  #trafficModal {
    z-index: 1000;
  }

  #trafficModal .modal-content {
    max-height: 90vh;
  }

  .device-card {
    transition: all 0.2s ease;
  }

  .device-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .progress-bar {
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
    background-color: #e5e7eb;
  }

  .progress-segment {
    height: 100%;
    display: inline-block;
  }

  #realtimeStatusPill {
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
  }

  #realtimeStatusPill[data-state="connecting"] {
    background-color: #fef3c7;
    color: #92400e;
    border-color: #f59e0b;
  }

  #realtimeStatusPill[data-state="connected"] {
    background-color: #dcfce7;
    color: #166534;
    border-color: #16a34a;
  }

  #realtimeStatusPill[data-state="offline"] {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #f87171;
  }

  #realtimeStatusText[data-state="connecting"] {
    color: #92400e;
  }

  #realtimeStatusText[data-state="connected"] {
    color: #166534;
  }

  #realtimeStatusText[data-state="offline"] {
    color: #991b1b;
  }

  #realtimeStatusDot {
    transition: background-color 0.2s ease;
  }

  #realtimeStatusDot[data-state="connecting"] {
    background-color: #f59e0b;
  }

  #realtimeStatusDot[data-state="connected"] {
    background-color: #16a34a;
  }

  #realtimeStatusDot[data-state="offline"] {
    background-color: #dc2626;
  }

  /* Legacy terminal styles removed/updated */
  .terminal-container {
    display: none; /* Hide the legacy virtual terminal */
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Fiber Route Map</h2>
    <div class="text-sm text-gray-600 bg-white px-4 py-2 rounded-lg shadow-sm">
      <span class="mr-4">Total: <strong id="summary-total" class="font-semibold">{{ hosts_summary.total }}</strong></span>
      <span class="mr-4 text-green-600">Available: <strong id="summary-available" class="font-semibold">{{ hosts_summary.available }}</strong></span>
      <span class="mr-4 text-red-600">Unavailable: <strong id="summary-unavailable" class="font-semibold">{{ hosts_summary.unavailable }}</strong></span>
    <span class="text-gray-500">Unknown: <strong id="summary-unknown" class="font-semibold">{{ hosts_summary.unknown }}</strong></span>
  </div>
</div>
<div class="mt-2 text-xs">
    <span id="realtimeStatusPill" data-state="connecting" class="inline-flex items-center gap-2 px-2 py-1 rounded-full border border-gray-200 bg-gray-100 text-gray-600">
      <span id="realtimeStatusDot" data-state="connecting" class="inline-block w-2 h-2 rounded-full bg-gray-400"></span>
      <span id="realtimeStatusText" data-state="connecting">Initializing realtime updates...</span>
    </span>
  </div>

  <ul id="cableList" class="space-y-1 text-sm"></ul>

  <ul id="siteList" class="space-y-1 text-sm"></ul>

  <!-- Map Section -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 overflow-hidden">
    <div id="map" class="rounded-lg"></div>
  </div>

  <!-- Status Summary -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Availability Status</h3>
      <div class="text-right">
        <span id="summary-availability" class="text-2xl font-bold text-green-600">{{ hosts_summary.availability_percentage }}%</span>
        <span class="text-sm text-gray-500 block">Availability</span>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-bar mb-4">
      {% if hosts_summary.total > 0 %}
        <div id="progress-available" class="progress-segment bg-green-500" style="width: {{ hosts_summary.availability_percentage }}%"></div>
        <div id="progress-unavailable" class="progress-segment bg-red-500" style="width: {% widthratio hosts_summary.unavailable hosts_summary.total 100 %}%"></div>
        <div id="progress-unknown" class="progress-segment bg-gray-400" style="width: {% widthratio hosts_summary.unknown hosts_summary.total 100 %}%"></div>
      {% endif %}
    </div>
    
    <!-- Legend -->
    <div class="flex justify-center space-x-6 text-xs">
      <div class="flex items-center">
        <span class="status-indicator status-available"></span>
        <span>Available ({{ hosts_summary.available }})</span>
      </div>
      <div class="flex items-center">
        <span class="status-indicator status-unavailable"></span>
        <span>Unavailable ({{ hosts_summary.unavailable }})</span>
      </div>
      <div class="flex items-center">
        <span class="status-indicator status-unknown"></span>
        <span>Unknown ({{ hosts_summary.unknown }})</span>
      </div>
    </div>
  </div>

  <!-- Devices Grid -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Monitored Devices</h3>
    
    <div id="hostsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {% for host in hosts_status %}
      <div class="device-card p-4 border rounded-lg {{ host.status_class }}" data-host-id="{{ host.hostid }}">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center space-x-2 flex-1 min-w-0">
            <span class="status-indicator" style="background-color: {{ host.color }}"></span>
            <span class="font-medium text-sm truncate" title="{{ host.name }}">{{ host.name }}</span>
          </div>
          <span class="text-xs px-2 py-1 rounded-full font-medium {{ host.status_class }} whitespace-nowrap">
            {{ host.available_text }}
          </span>
        </div>
        
        <div class="space-y-2 text-xs text-gray-600">
          <div class="flex justify-between">
            <span class="font-medium">Site:</span>
            <span class="text-right truncate ml-2" title="{{ host.site }}">{{ host.site }}</span>
          </div>
          
          
          {% if host.interface.ip %}
          <div class="flex justify-between items-center">
            <span class="font-medium">IP:</span>
            <button type="button"
                    class="ip-action-trigger text-blue-600 hover:text-blue-800 underline ml-2 truncate max-w-[130px] text-left"
                    data-ip="{{ host.interface.ip }}"
                    title="{{ host.interface.ip }}">
              {{ host.interface.ip }}
            </button>
          </div>
          {% endif %}
          
          <div class="flex justify-between">
            <span class="font-medium">Host ID:</span>
            <span class="text-right font-mono text-xs" title="{{ host.hostid }}">{{ host.hostid|truncatechars:10 }}</span>
          </div>
        </div>
        
        {% if host.error %}
        <div class="mt-3 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
          <strong class="block mb-1">Zabbix Error:</strong>
          <span class="break-words">{{ host.error|truncatechars:100 }}</span>
        </div>
        {% endif %}

        <!-- Traffic chart button -->
        {% if host.interface.interfaceid %}
        <div class="mt-3 pt-3 border-t border-gray-200">
        </div>
        {% endif %}
      </div>
      {% empty %}
      <div class="col-span-full text-center py-8">
        <div class="text-gray-400 mb-3">
          <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
        <p class="text-gray-500 mb-2">No devices configured with Zabbix</p>
        <p class="text-xs text-gray-400">
          Configure the "zabbix_hostid" field for the device in Django Admin
        </p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Traffic Modal -->
<div id="trafficModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black bg-opacity-75" onclick="closeTrafficModal()"></div>
  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-6xl bg-white rounded-lg shadow-xl max-h-[90vh] flex flex-col">
    <!-- Header -->
    <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800" id="trafficModalTitle">Traffic History</h3>
      <button class="text-gray-400 hover:text-gray-600 text-2xl leading-none" onclick="closeTrafficModal()">&times;</button>
    </div>
    
    <!-- Content -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
      <!-- Loading -->
      <div id="trafficModalLoading" class="flex-1 flex items-center justify-center p-8">
        <div class="text-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">Loading traffic data...</p>
        </div>
      </div>
      
      <!-- Error -->
      <div id="trafficModalError" class="hidden flex-1 flex items-center justify-center p-8">
        <div class="text-center text-red-600">
          <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p id="trafficModalErrorText" class="whitespace-pre-line"></p>
        </div>
      </div>
      
      <!-- Chart Content -->
      <div id="trafficChartContainer" class="hidden flex-1 flex flex-col md:flex-row">
        <!-- Chart Area -->
        <div class="flex-1 p-6 min-h-96">
          <canvas id="trafficChartCanvas"></canvas>
        </div>
        
        <!-- Stats Table -->
        <div id="trafficStatsTable" class="w-full md:w-80 border-t md:border-t-0 md:border-l border-gray-200 p-4 bg-gray-50 overflow-y-auto">
          <!-- Table is populated dynamically -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Global Ping/Telnet modal (updated) -->
<div id="pingTelnetActionModal" class="fixed inset-0 z-[1100] hidden">
  <div class="absolute inset-0 bg-black/60" data-close-modal></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
    <div class="flex items-center justify-between mb-4">
      <h4 class="text-lg font-semibold text-gray-800">Actions for <span id="actionIpLabel" class="font-mono text-sm text-blue-600"></span></h4>
      <button class="text-gray-400 hover:text-gray-600 text-xl leading-none" data-close-modal>&times;</button>
    </div>
    <div class="space-y-3">
      <button type="button" id="btnPingHost" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">Ping (CMD)</button>
      <button type="button" id="btnTelnetHost" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm font-medium">Telnet (CMD)</button>
      <button type="button" id="btnPingTelnetWindow" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">Ping & Telnet (CMD)</button>
      <button type="button" data-close-modal class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm font-medium">Cancel</button>
    </div>
  </div>
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Custom JavaScript -->
{{ hosts_status|json_script:"hosts-data" }}
{{ hosts_summary|json_script:"hosts-summary" }}
<script>
  const GOOGLE_MAPS_API_KEY = "{{ GOOGLE_MAPS_API_KEY }}";
  const HOSTS_DATA = JSON.parse(document.getElementById('hosts-data').textContent || '[]');
  const HOSTS_SUMMARY = JSON.parse(document.getElementById('hosts-summary').textContent || '{}');
</script>

<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/traffic_chart.js' %}"></script>

<!-- Google Maps -->
<script async defer 
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap&libraries=geometry">
</script>

<script>
// Utilidades para modal de actions Ping/Telnet - MODIFICADO
(function(){
  const modal = document.getElementById('pingTelnetActionModal');
  if(!modal) return;
  const ipLabel = document.getElementById('actionIpLabel');
  const btnPing = document.getElementById('btnPingHost');
  const btnTelnet = document.getElementById('btnTelnetHost');
  const btnPingTelnetWindow = document.getElementById('btnPingTelnetWindow');
  let currentIp = null;

  function openModal(ip){
    currentIp = ip;
    if(ipLabel) ipLabel.textContent = ip;
    modal.classList.remove('hidden');
    setTimeout(()=>btnPing?.focus(), 10);
  }
  
  function closeModal(){
    modal.classList.add('hidden');
    currentIp = null;
  }

  // New helpers for launching Windows CMD actions
  function openCmdWithPing(ip) {
    // Try using the cmd:// protocol to start a ping command
    const command = `ping ${ip}`;
    openWindowsCmd(command);
  }

  function openCmdWithTelnet(ip, port = 23) {
    const command = `telnet ${ip} ${port}`;
    openWindowsCmd(command);
  }

  function openCmdWithPingAndTelnet(ip, port = 23) {
    // Launch ping first and cascade to telnet
    const command = `ping ${ip} && telnet ${ip} ${port}`;
    openWindowsCmd(command);
  }

  function openWindowsCmd(command) {
    // Method 1: cmd:// protocol
    try {
      window.location.href = `cmd:///k ${command}`;
    } catch (e) {
      // Method 2: fall back to a temporary batch file
      fallbackCmdOpen(command);
    }
  }

  function fallbackCmdOpen(command) {
    // Alternative method: download a .bat file with the command
    const batContent = `@echo off\n${command}\npause`;
    const blob = new Blob([batContent], { type: 'application/bat' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'command.bat';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Provide guidance to the operator
    alert('Downloaded command.bat. Run it to open CMD with the selected commands.');
  }

  function ping(){
    if(!currentIp) return;
    openCmdWithPing(currentIp);
    closeModal();
  }

  function telnet(){
    if(!currentIp) return;
    openCmdWithTelnet(currentIp);
    closeModal();
  }

  function pingTelnetWindow(){
    if(!currentIp) return;
    openCmdWithPingAndTelnet(currentIp);
    closeModal();
  }

  // Event Listeners
  document.addEventListener('click', (e)=>{
    const trigger = e.target.closest('.ip-action-trigger');
    if(trigger){
      const ip = trigger.getAttribute('data-ip');
      if(ip) openModal(ip);
      return;
    }
    if(e.target.matches('[data-close-modal]')){
      closeModal();
      return;
    }
  });
  
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
  });
  
  btnPing?.addEventListener('click', ping);
  btnTelnet?.addEventListener('click', telnet);
  btnPingTelnetWindow?.addEventListener('click', pingTelnetWindow);
})();

// Legacy virtual terminal helpers removed in favor of native CMD actions

// Utility to display quick toast notifications
function showNotification(message, type = 'info') {
  // Minimal notification implementation
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${
    type === 'info' ? 'bg-blue-500 text-white' : 
    type === 'success' ? 'bg-green-500 text-white' : 
    'bg-red-500 text-white'
  }`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    document.body.removeChild(notification);
  }, 3000);
}
</script>

{% endblock %}
