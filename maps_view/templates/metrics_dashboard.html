{% extends 'base_dashboard.html' %}

{% block title %}Prometheus Metrics · Fiber Network{% endblock %}

{% block content %}
<section class="bg-white shadow rounded-lg p-6">
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Prometheus Metrics</h1>
      <p class="text-sm text-gray-600">Visualização amigável das métricas expostas em <code>/metrics/</code>.</p>
    </div>
    <form method="get" class="w-full sm:w-80">
      <label for="metrics-search" class="sr-only">Filtrar métricas</label>
      <div class="relative">
        <input
          id="metrics-search"
          type="search"
          name="q"
          value="{{ query }}"
          placeholder="Buscar por nome ou descrição..."
          class="w-full rounded-md border border-gray-300 py-2 pl-10 pr-3 text-sm focus:border-blue-500 focus:ring-blue-500"
        >
        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 104.473 8.773l3.127 3.127a.75.75 0 101.06-1.06l-3.127-3.127A5.5 5.5 0 009 3.5zM4.5 9a4.5 4.5 0 118.688 2.396.757.757 0 00-.146.146A4.5 4.5 0 014.5 9z" clip-rule="evenodd" />
          </svg>
        </span>
      </div>
    </form>
  </header>

  {% if metrics %}
    <p class="text-sm text-gray-500 mb-4">
      Exibindo <span class="font-semibold">{{ metrics|length }}</span> métricas registradas.
      {% if query %}Filtro aplicado: <span class="italic">{{ query }}</span>.{% endif %}
    </p>

    <div class="space-y-6">
      {% for metric in metrics %}
        <article class="border border-gray-200 rounded-lg">
          <div class="px-5 py-4 bg-gray-50 border-b border-gray-200 flex flex-col gap-1">
            <div class="flex items-center justify-between gap-2">
              <h2 class="font-medium text-gray-900 break-all">{{ metric.name }}</h2>
              <span class="text-xs uppercase tracking-wide text-gray-500 bg-gray-200 rounded-full px-2 py-0.5">
                {{ metric.type|default:"untyped" }}
              </span>
            </div>
            {% if metric.help %}
              <p class="text-sm text-gray-600">{{ metric.help }}</p>
            {% endif %}
          </div>
          <div class="divide-y divide-gray-200">
            {% for sample in metric.samples %}
              <div class="px-5 py-3 text-sm text-gray-700 flex flex-col gap-1">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <code class="text-xs font-mono bg-gray-100 rounded px-2 py-1 break-all">{{ sample.raw }}</code>
                  <span class="text-xs font-semibold text-gray-800">Valor: {{ sample.value }}</span>
                </div>
                {% if sample.labels %}
                  <dl class="flex flex-wrap gap-x-6 gap-y-1 text-xs text-gray-500">
                    {% for key, val in sample.labels.items %}
                      <div>
                        <dt class="font-medium text-gray-600 uppercase tracking-wide">{{ key }}</dt>
                        <dd class="font-mono">{{ val }}</dd>
                      </div>
                    {% endfor %}
                  </dl>
                {% endif %}
              </div>
            {% empty %}
              <p class="px-5 py-3 text-sm text-gray-500">Sem amostras registradas.</p>
            {% endfor %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-12 text-gray-500">
      <p>Nenhuma métrica disponível no momento{% if query %} para o filtro aplicado{% endif %}.</p>
      <p class="text-xs mt-2">Confirme se o scraper Prometheus está apontando para <code>{{ metrics_source_url }}</code>.</p>
    </div>
  {% endif %}
</section>
{% endblock %}
