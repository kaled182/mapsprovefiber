{% extends "base.html" %}
{% load static %}

{% block title %}Lookup Zabbix{% endblock %}

{% block content %}
<div class="space-y-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-semibold text-gray-900">Lookup Zabbix</h1>
      <p class="mt-1 text-sm text-gray-600">
        Search hosts directly in Zabbix, import devices, and review ports with their optical levels.
      </p>
    </div>
    <div class="flex flex-wrap gap-3">
      <a href="{% url 'routes_builder:fiber_route_builder' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
        Route Builder
      </a>
      <a href="{% url 'maps_view:dashboard_view' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
        Dashboard
      </a>
    </div>
  </div>

  <div class="grid gap-6 xl:grid-cols-2">
    <!-- Busca de hosts -->
    <section class="rounded-xl border border-gray-200 bg-white shadow-sm">
      <header class="border-b border-gray-100 px-6 py-4">
        <h2 class="text-lg font-semibold text-gray-900">Search hosts</h2>
        <p class="mt-1 text-sm text-gray-500">Filter by name, IP, or groups to locate devices quickly.</p>
      </header>
      <div class="px-6 py-5 space-y-4">
        <div class="grid gap-3 md:grid-cols-[1.5fr,1fr]">
          <input id="q" class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-500/20"
                 placeholder="Example: core, 192.168." />
          <input id="groupids" class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-500/20"
                 placeholder="Group IDs (optional): 2,15" />
        </div>
        <div class="flex items-center justify-between gap-3">
          <button id="btnSearch"
                  class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring focus:ring-blue-500/30">
            Search
          </button>
          <span id="count" class="text-sm text-gray-500"></span>
        </div>
        <div id="hosts" class="space-y-3">
          <div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-sm text-gray-500 text-center">
            Enter a term or group and click Search to begin.
          </div>
        </div>
      </div>
    </section>

    <!-- Selected host -->
    <section class="rounded-xl border border-gray-200 bg-white shadow-sm">
      <header class="border-b border-gray-100 px-6 py-4">
        <h2 class="text-lg font-semibold text-gray-900">Selected host</h2>
        <p class="mt-1 text-sm text-gray-500">Review host details, add it to the inventory, and inspect available interfaces.</p>
      </header>
      <div class="px-6 py-5 space-y-4">
        <div id="hostInfo" class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
          No host selected.
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <button id="btnAddDevice" disabled
                  class="inline-flex items-center justify-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-300 focus:outline-none focus:ring focus:ring-blue-500/30">
            + Add to inventory
          </button>
          <span id="addResult" class="text-sm text-gray-500"></span>
        </div>
      <div>
        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Interfaces</h3>
        <div id="ifaces" class="mt-3 space-y-3">
          <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500 text-center">
            Select a host to list interfaces.
          </div>
        </div>
      </div>
      <div>
        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Device ports</h3>
        <div id="ports" class="mt-3 space-y-3">
          <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
            Add the device to the inventory to list ports.
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<section class="rounded-xl border border-gray-200 bg-white shadow-sm">
  <header class="border-b border-gray-100 px-6 py-4">
    <h2 class="text-lg font-semibold text-gray-900">Quick tests</h2>
    <p class="mt-1 text-sm text-gray-500">Run ping, telnet, or both against the selected host to validate connectivity.</p>
  </header>
  <div class="px-6 py-5 space-y-4">
    <div class="grid gap-3 md:grid-cols-[1.5fr,1fr]">
      <input id="testHost" class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-500/20"
             placeholder="Host or IP" />
      <input id="testPort" class="rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring focus:ring-blue-500/20"
             placeholder="Port (e.g. 22)" />
    </div>
    <div class="flex flex-wrap gap-2">
      <button id="btnPing"
              class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring focus:ring-blue-500/30">
        Ping
      </button>
      <button id="btnTelnet"
              class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring focus:ring-blue-500/30">
        Telnet
      </button>
      <button id="btnPingTelnet"
              class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring focus:ring-blue-500/30">
        Ping + Telnet
      </button>
    </div>
    <pre id="testOutput" class="max-h-64 overflow-auto rounded-lg bg-slate-900 px-4 py-3 text-sm text-cyan-200 shadow-inner">Output will appear here...</pre>
  </div>
</section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const csrfToken = "{{ csrf_token }}";
  const API = "/zabbix_api";
  const $ = (selector) => document.querySelector(selector);

  const hostsEl = $("#hosts");
  const ifacesEl = $("#ifaces");
  const portsEl = $("#ports");
  const hostInfoEl = $("#hostInfo");
  const addBtn = $("#btnAddDevice");
  const addRes = $("#addResult");
  let currentHost = null;
  let currentDevice = null;

  async function fetchJSON(url, options = {}) {
    const resp = await fetch(url, options);
    let data = null;
    try { data = await resp.json(); } catch (_) {}
    if (!resp.ok) throw new Error((data && (data.error || data.message)) || resp.statusText);
    return data;
  }

  function fmtDbm(value) {
    if (value === null || value === undefined || Number.isNaN(value)) return "-";
    const num = typeof value === "number" ? value : parseFloat(value);
    if (Number.isNaN(num)) return "-";
    return `${num.toFixed(1)} dBm`;
  }

  function normalizeHost(host) {
    const hostid = host?.hostid ?? host?.host_id ?? host?.id ?? host?.hostId ?? (Array.isArray(host?.hostids) ? host.hostids[0] : undefined);
    const name = host?.name || host?.host || host?.visible_name || "";
    const slug = host?.host || host?.name || "";
    const status = host?.status ?? null;
    let availability = host?.availability || null;
    const availableFallback = host?.available ?? null;
    if (!availability || availability.value === undefined) {
      if (availableFallback === "1" || availableFallback === 1) {
        availability = { channel: "agent", value: "1", state: "online", label: "Online", error: host?.error || null };
      } else if (availableFallback === "2" || availableFallback === 2) {
        availability = { channel: "agent", value: "2", state: "offline", label: "Offline", error: host?.error || null };
      }
    }
    if (!availability) {
      availability = { channel: null, value: null, state: "unknown", label: "Unknown", error: null };
    }
    const availableValue = availability?.value ?? (availableFallback != null ? String(availableFallback) : null);
    const ip = host?.ip || "";
    return { hostid, name, slug, status, availability, available: availableValue, ip, _raw: host };
  }

  function renderStatusBadge(status, availability) {
    const baseClass = "inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium border";
    const avail = availability || {};
    const value = avail.value;
    const label = avail.label || "Unknown";
    const tooltip = avail.error ? `title="${avail.error.replace(/"/g, '&quot;')}"` : "";
    const prefix = "DEVICE";

    if (!value) {
      return `<span ${tooltip} class="${baseClass} border-gray-200 bg-gray-100 text-gray-600"><span class="text-base leading-none">&#9679;</span>${prefix}  ${label}</span>`;
    }

    let classes = "border-gray-200 bg-gray-100 text-gray-600";
    if (String(value) === "1") {
      classes = "border-green-200 bg-green-100 text-green-700";
    } else if (String(value) === "2") {
      classes = "border-red-200 bg-red-100 text-red-700";
    }

    return `<span ${tooltip} class="${baseClass} ${classes}"><span class="text-base leading-none">&#9679;</span>${prefix}  ${label}</span>`;
  }


  function renderHostCard(host) {
    const disabled = host.hostid ? "" : "disabled";
    const statusBadge = renderStatusBadge(host.status, host.availability);
    const encodedName = encodeURIComponent(host.name || host.slug || "");
    const availability = host.availability || {};
    const availabilityLabel = encodeURIComponent(availability.label || "");
    const availabilityError = encodeURIComponent(availability.error || "");
    return `
      <div class="flex items-start justify-between gap-3 rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
        <div>
          <p class="font-medium text-gray-900">${host.name || host.slug}</p>
          <p class="text-xs text-gray-500">hostid: ${host.hostid ?? "-"}</p>
          <p class="text-xs text-gray-500">IP: ${host.ip || "-"}</p>
          <div class="mt-2">${statusBadge}</div>
        </div>
        <button type="button" ${disabled}
          data-hostid="${host.hostid || ""}"
          data-name="${encodedName}"
          data-status="${host.status ?? ""}"
          data-ip="${host.ip || ""}"
          data-availability-value="${availability.value ?? ""}"
          data-availability-channel="${availability.channel ?? ""}"
          data-availability-label="${availabilityLabel}"
          data-availability-error="${availabilityError}"
          class="inline-flex items-center justify-center rounded-md bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-300">
          Select
        </button>
      </div>
    `;
  }

  function attachHostButtons() {
    hostsEl.querySelectorAll("button[data-hostid]").forEach((button) => {
      button.addEventListener("click", () => {
        const hostid = button.getAttribute("data-hostid") || "";
        const name = decodeURIComponent(button.getAttribute("data-name") || "");
        const ip = button.getAttribute("data-ip") || "";
        let status = button.getAttribute("data-status");
        const availability = {
          value: button.getAttribute("data-availability-value") || null,
          channel: button.getAttribute("data-availability-channel") || null,
          label: decodeURIComponent(button.getAttribute("data-availability-label") || "") || "Unknown",
          error: decodeURIComponent(button.getAttribute("data-availability-error") || "") || null,
        };
        if (availability.value === "" || availability.value === "null" || availability.value === "undefined") {
          availability.value = null;
        }
        if (!availability.label) {
          availability.label = availability.value === "1" ? "Online" : availability.value === "2" ? "Offline" : "Unknown";
        }
        if (status === "" || status === "null" || status === "undefined") status = null;
        selectHost(hostid, name, status, availability, ip);
      });
    });
  }

  $("#btnSearch").addEventListener("click", async () => {
    const q = $("#q").value.trim();
    const groupids = $("#groupids").value.trim();
    const params = new URLSearchParams();
    if (q) params.set("q", q);
    if (groupids) params.set("groupids", groupids);

    if (!q && !groupids) {
      hostsEl.innerHTML = `
        <div class="rounded-lg border border-dashed border-red-200 bg-red-50 px-4 py-4 text-sm text-red-600">
          Provide <strong>q</strong> or <strong>groupids</strong> before searching.
        </div>`;
      return;
    }

    hostsEl.innerHTML = `
      <div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500">
        Searching hosts...
      </div>`;

    try {
      const data = await fetchJSON(`${API}/lookup/hosts/?${params.toString()}`);
      $("#count").textContent = `${data.count} result(s)`;
      const items = (data.data || []).map(normalizeHost);
      hostsEl.innerHTML = items.length
        ? items.map(renderHostCard).join("")
        : `<div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500 text-center">No results found.</div>`;
      attachHostButtons();
    } catch (error) {
      hostsEl.innerHTML = `
        <div class="rounded-lg border border-dashed border-red-200 bg-red-50 px-4 py-4 text-sm text-red-600">
          Error while searching hosts: ${error.message}
        </div>`;
    }
  });

  function renderSelectedHostInfo() {
    if (!currentHost) {
      hostInfoEl.innerHTML = `
        <div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
          No host selected.
        </div>`;
      return;
    }
    const badge = renderStatusBadge(currentHost.status, currentHost.availability);
    hostInfoEl.innerHTML = `
      <div class="rounded-lg border border-gray-200 bg-blue-50 px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-blue-900">${currentHost.name}</p>
            <p class="text-xs text-blue-700">hostid: ${currentHost.hostid}</p>
            ${currentHost.ip ? '<p class="text-xs text-blue-700">IP: ' + currentHost.ip + '</p>' : ""}
          </div>
          ${badge}
        </div>
      </div>`;
  }

  async function refreshHostAvailability(hostid) {
    try {
      const payload = await fetchJSON(`${API}/lookup/hosts/${encodeURIComponent(hostid)}/status/`);
      if (!currentHost || String(currentHost.hostid) !== String(hostid)) {
        return;
      }
      const availability = payload?.data?.availability || currentHost.availability;
      currentHost.availability = availability;
      currentHost.available = availability?.value ?? null;
      const updatedIp = payload?.data?.primary_interface?.ip;
      if (updatedIp) {
        currentHost.ip = updatedIp;
      }
      renderSelectedHostInfo();
    } catch (error) {
      addRes.textContent = `Availability lookup failed: ${error.message}`;
    }
  }

  async function selectHost(hostid, name, status = null, availability = null, ip = "") {
    if (!hostid) {
      hostInfoEl.innerHTML = `
        <div class="rounded-lg border border-dashed border-yellow-200 bg-yellow-50 px-4 py-4 text-sm text-yellow-700">
          <strong>${name}</strong><br>This record does not contain a host ID, so interfaces cannot be listed.
        </div>`;
      addBtn.disabled = true;
      ifacesEl.innerHTML = `
        <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500 text-center">
          Without a host ID the interfaces cannot be listed.
        </div>`;
      portsEl.innerHTML = `
        <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
          Add the device to the inventory to list ports.
        </div>`;
      currentHost = null;
      return;
    }

    const availabilityValue = availability?.value ?? null;
    currentHost = { hostid, name, slug: name, status, availability, available: availabilityValue, ip: ip || (currentHost && currentHost.ip) || "" };
    addBtn.disabled = false;
    addRes.textContent = "";
    renderSelectedHostInfo();
    refreshHostAvailability(hostid);

    ifacesEl.innerHTML = `
      <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500 text-center">
        Carregando interfaces...
      </div>`;

    try {
      const data = await fetchJSON(`${API}/lookup/hosts/${encodeURIComponent(hostid)}/interfaces/?only_main=true`);
      const interfaces = data.data || [];
      ifacesEl.innerHTML = interfaces.length
        ? interfaces.map((iface) => `
            <div class="rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
              <p class="text-sm font-medium text-gray-900">ifaceid: ${iface.interfaceid}</p>
              <p class="text-xs text-gray-500">
                ${iface.ip ? `IP: ${iface.ip}` : ""} ${iface.dns ? `- DNS: ${iface.dns}` : ""} ${iface.port ? `- Porta: ${iface.port}` : ""}
              </p>
            </div>`).join("")
        : `<div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-4 text-sm text-gray-500 text-center">No interfaces returned.</div>`;
    } catch (error) {
      ifacesEl.innerHTML = `
        <div class="rounded-md border border-dashed border-red-200 bg-red-50 px-4 py-4 text-sm text-red-600 text-center">
          Error while loading interfaces: ${error.message}
        </div>`;
    }

    portsEl.innerHTML = `
      <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
        Add the device to the inventory to list ports.
      </div>`;
  }

  window.selectHost = selectHost;

  addBtn.addEventListener("click", async () => {
    if (!currentHost) return;
    addBtn.disabled = true;
    addRes.textContent = "Adding...";
    try {
      const response = await fetchJSON(`${API}/api/add-device-from-zabbix/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({ hostid: currentHost.hostid })
      });
      currentDevice = response.device;
      const createdMessage = response.created ? "created" : "existing";
      addRes.textContent = `Device ${createdMessage}: ${response.device.name} (id=${response.device.id}). Ports detected: ${response.total_ports_detected}.`;
      await loadPortsWithOptical(response.device.id, response.device.name);
    } catch (error) {
      addRes.textContent = `Error: ${error.message}`;
    } finally {
      addBtn.disabled = false;
    }
  });

  function renderPortCard(port) {
    const optical = port.optical || {};
    return `
      <div class="flex items-start justify-between gap-4 rounded-lg border border-gray-200 bg-white px-4 py-4 shadow-sm" id="port-${port.id}">
        <div class="space-y-2">
          <div>
            <p class="text-sm font-semibold text-gray-900">${port.name}</p>
            <p class="text-xs text-gray-500">Port #${port.id}</p>
          </div>
          <p class="text-xs text-gray-500">
            Cable: ${port.cable_name || "-"} <span class="text-gray-400">(${port.cable_id || "-"})</span>
          </p>
          <p class="text-xs text-gray-500" id="opt-${port.id}">
            Optical: RX=${fmtDbm(optical.rx_dbm)} | TX=${fmtDbm(optical.tx_dbm)}
          </p>
        </div>
        <div class="flex flex-col gap-2">
          <button onclick="refreshOptical(${port.id})"
            class="inline-flex items-center justify-center rounded-md border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-medium text-blue-700 hover:bg-blue-100">
             Optical
          </button>
          <button onclick="viewTraffic(${port.id})"
            class="inline-flex items-center justify-center rounded-md border border-gray-200 bg-white px-3 py-1 text-xs font-medium text-gray-700 hover:bg-gray-100">
            Traffic
          </button>
        </div>
      </div>
    `;
  }

  async function loadPortsWithOptical(deviceId, deviceName) {
    portsEl.innerHTML = `
      <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
        Loading ports from ${deviceName}...
      </div>`;
    try {
      const data = await fetchJSON(`${API}/api/device-ports-optical/${deviceId}/`);
      const ports = data.ports || [];
      if (!ports.length) {
        portsEl.innerHTML = `
          <div class="rounded-md border border-dashed border-gray-200 bg-gray-50 px-4 py-6 text-center text-sm text-gray-500">
            No ports were returned by the inventory.
          </div>`;
        return;
      }
      portsEl.innerHTML = ports.map(renderPortCard).join("");
      for (const port of ports) {
        const { rx_dbm, tx_dbm } = port.optical || {};
        if (rx_dbm == null && tx_dbm == null) {
          refreshOptical(port.id);
        }
      }
    } catch (error) {
      portsEl.innerHTML = `
        <div class="rounded-md border border-dashed border-red-200 bg-red-50 px-4 py-6 text-center text-sm text-red-600">
          Error while loading ports: ${error.message}
        </div>`;
    }
  }

  window.refreshOptical = async (portId) => {
    const target = document.getElementById(`opt-${portId}`);
      if (target) target.textContent = "Optical: loading...";
    try {
      const data = await fetchJSON(`${API}/api/port-optical-status/${portId}/`);
      const rx = data?.optical?.rx_dbm;
      const tx = data?.optical?.tx_dbm;
      if (target) target.textContent = `Optical: RX=${fmtDbm(rx)} | TX=${fmtDbm(tx)}`;
    } catch (error) {
      if (target) target.textContent = `Optical: error (${error.message})`;
    }
  };

  window.viewTraffic = async (portId) => {
    try {
      const data = await fetchJSON(`${API}/api/port-traffic-history/${portId}/?period=24h`);
      const lastIn = data.in.history.at(-1)?.value ?? "-";
      const lastOut = data.out.history.at(-1)?.value ?? "-";
      alert(`Port #${portId}\nIN (latest): ${lastIn} ${data.in.unit}\nOUT (latest): ${lastOut} ${data.out.unit}`);
    } catch (error) {
      alert(`Error while retrieving traffic: ${error.message}`);
    }
  };

  async function showTest(url) {
    try {
      const result = await fetchJSON(url);
      $("#testOutput").textContent = JSON.stringify(result, null, 2);
    } catch (error) {
      $("#testOutput").textContent = `Error: ${error.message}`;
    }
  }

  $("#btnPing").addEventListener("click", () => {
    const ip = $("#testHost").value.trim();
    if (!ip) return;
    showTest(`${API}/api/test/ping/?ip=${encodeURIComponent(ip)}&count=1`);
  });

  $("#btnTelnet").addEventListener("click", () => {
    const ip = $("#testHost").value.trim();
    const port = $("#testPort").value.trim() || "23";
    if (!ip) return;
    showTest(`${API}/api/test/telnet/?ip=${encodeURIComponent(ip)}&port=${encodeURIComponent(port)}`);
  });

  $("#btnPingTelnet").addEventListener("click", () => {
    const ip = $("#testHost").value.trim();
    const port = $("#testPort").value.trim() || "23";
    if (!ip) return;
    showTest(`${API}/api/test/ping_telnet/?ip=${encodeURIComponent(ip)}&port=${encodeURIComponent(port)}`);
  });
</script>
{% endblock %}
